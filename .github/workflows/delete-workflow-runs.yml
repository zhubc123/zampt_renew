name: Clear All Workflow Runs

on:
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘
    inputs:
      dry_run:
        description: 'æ˜¯å¦ä»…æ¨¡æ‹Ÿï¼ˆä¸å®é™…åˆ é™¤ï¼‰ï¼Ÿ true/false'
        required: true
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'

jobs:
  delete-runs:
    runs-on: ubuntu-latest
    permissions:
      actions: write  # å¿…éœ€ï¼šå…è®¸åˆ é™¤ runs
      contents: read   # æ¨èï¼šå…è®¸è¯»å–ä»“åº“ä¿¡æ¯

    steps:
      - name: Delete all workflow runs
        env:
          DRY_RUN: ${{ inputs.dry_run }}
          GH_TOKEN: ${{ github.token }}  # ä½¿ç”¨é»˜è®¤ token
        run: |
          echo "å¼€å§‹å¤„ç†ä»“åº“ ${{ github.repository }} çš„æ‰€æœ‰ workflow runs..."
          if [ "$DRY_RUN" = "true" ]; then
            echo "ğŸš¨ å¹²è·‘æ¨¡å¼ï¼ˆdry runï¼‰ï¼šä»…åˆ—å‡ºå°†åˆ é™¤çš„ runsï¼Œä¸ä¼šå®é™…åˆ é™¤ã€‚"
          else
            echo "âš ï¸  çœŸå®åˆ é™¤æ¨¡å¼ï¼šå°†æ°¸ä¹…åˆ é™¤æ‰€æœ‰ runsï¼"
          fi

          # åˆ†é¡µè·å–æ‰€æœ‰ run IDï¼ˆper_page=100ï¼Œ--paginate è‡ªåŠ¨å¤„ç†å¤šé¡µï¼‰
          gh api --paginate "/repos/${{ github.repository }}/actions/runs?per_page=100" \
            --jq '.workflow_runs[].id' |
          while read -r run_id; do
            if [ -n "$run_id" ]; then
              if [ "$DRY_RUN" = "true" ]; then
                echo "æ¨¡æ‹Ÿåˆ é™¤ run ID: $run_id"
              else
                echo "æ­£åœ¨åˆ é™¤ run ID: $run_id"
                gh api -X DELETE "/repos/${{ github.repository }}/actions/runs/$run_id"
                # å¯é€‰ï¼šåŠ å»¶æ—¶é¿å… rate limit
                # sleep 0.5
              fi
            fi
          done

          echo "å®Œæˆï¼"
